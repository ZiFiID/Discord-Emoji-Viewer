<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Discord Emoji Viewer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap');

    :root {
      --background: #36393f;
      --background-secondary: #2f3136;
      --background-tertiary: #202225;
      --text-primary: #dcddde;
      --text-muted: #72767d;
      --accent: #5865f2;
      --scrollbar-bg: #202225;
      --scrollbar-thumb: #4e5d94;
      --copy-success-bg: #43b581;
    }

    * {
      box-sizing: border-box;
    }

    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background);
      color: var(--text-primary);
      user-select: none;
      overflow: hidden;
    }

    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
      user-select: none;
    }

    /* Sidebar */
    #sidebar {
      width: 300px;
      background-color: var(--background-secondary);
      display: flex;
      flex-direction: column;
      border-right: 1px solid #202225;
    }

    #sidebarHeader {
      padding: 20px 16px;
      font-weight: 700;
      font-size: 22px;
      border-bottom: 1px solid #202225;
      color: var(--accent);
      user-select: none;
    }

    #tokenSection {
      padding: 16px;
      border-bottom: 1px solid #202225;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #tokenInput {
      width: 100%;
      padding: 10px 14px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      background-color: var(--background-tertiary);
      color: var(--text-primary);
      outline-offset: 0;
      user-select: text;
      transition: outline 0.15s ease;
    }

    #tokenInput::placeholder {
      color: var(--text-muted);
    }

    #tokenInput:focus {
      outline: 2px solid var(--accent);
    }

    #loadButton {
      width: 100%;
      padding: 12px 0;
      background-color: var(--accent);
      border: none;
      border-radius: 4px;
      font-weight: 700;
      font-size: 15px;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s ease;
      user-select: none;
    }

    #loadButton:hover:not(:disabled) {
      background-color: #4752c4;
    }

    #loadButton:disabled {
      opacity: 0.5;
      cursor: default;
    }

    #usePreviousTokenBtn {
      width: 100%;
      padding: 10px 0;
      background-color: #4a4c59;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
      display: none; /* awalnya sembunyi */
    }

    #usePreviousTokenBtn:hover {
      background-color: #5a5c69;
    }

    #serverSearchContainer {
      padding: 12px 16px;
      border-bottom: 1px solid #202225;
      background-color: var(--background-tertiary);
      display: none;
    }

    #serverSearchInput {
      width: 100%;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #444;
      background-color: var(--background);
      color: var(--text-primary);
      outline-offset: 0;
      user-select: text;
      transition: border-color 0.2s ease;
    }

    #serverSearchInput::placeholder {
      color: var(--text-muted);
    }

    #serverSearchInput:focus {
      border-color: var(--accent);
    }

    #serverList {
      flex-grow: 1;
      overflow-y: auto;
      user-select: none;
    }

    #serverList::-webkit-scrollbar {
      width: 8px;
    }

    #serverList::-webkit-scrollbar-track {
      background: var(--background-secondary);
    }

    #serverList::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border-radius: 4px;
    }

    .server-item {
      padding: 12px 16px;
      cursor: pointer;
      border-radius: 8px;
      margin: 4px 12px;
      font-weight: 600;
      font-size: 15px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: background-color 0.15s ease;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .server-item:hover {
      background-color: #4f53a6;
    }

    .server-item.active {
      background-color: var(--accent);
      color: white;
    }

    .server-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      background-color: #40444b;
    }

    /* Main content */
    #mainContent {
      flex-grow: 1;
      background-color: var(--background);
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      user-select: none;
    }

    #searchContainer {
      margin-bottom: 15px;
      display: none;
    }

    #searchInput {
      width: 100%;
      padding: 10px 14px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #444;
      background-color: var(--background-tertiary);
      color: var(--text-primary);
      outline-offset: 0;
      user-select: text;
      transition: border-color 0.2s ease;
    }

    #searchInput::placeholder {
      color: var(--text-muted);
    }

    #searchInput:focus {
      border-color: var(--accent);
    }

    #emojiGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(90px,1fr));
      gap: 18px;
      flex-grow: 1;
      overflow-y: auto;
      user-select: none;
    }

    #emojiGrid::-webkit-scrollbar {
      width: 8px;
    }

    #emojiGrid::-webkit-scrollbar-track {
      background: var(--background);
    }

    #emojiGrid::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border-radius: 4px;
    }

    .emoji-card {
      background-color: var(--background-secondary);
      border-radius: 10px;
      padding: 10px 6px 10px 6px;
      cursor: pointer;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.15s ease;
      position: relative;
      gap: 4px;
      min-height: 110px;
      justify-content: center;
    }

    .emoji-card:hover {
      background-color: #4e509b;
    }

    .emoji-image {
      width: 48px;
      height: 48px;
      user-select: none;
      border-radius: 8px;
      pointer-events: none;
      object-fit: contain;
    }

    .emoji-name {
      font-size: 13px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      user-select: text;
      max-width: 100%;
      text-align: center;
    }

    /* Tooltip */
    #tooltip {
      position: fixed;
      background: var(--copy-success-bg);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 700;
      color: white;
      opacity: 0;
      pointer-events: none;
      user-select: none;
      transition: opacity 0.2s ease;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="sidebar">
      <div id="sidebarHeader">Discord Emoji Viewer</div>
      <div id="tokenSection">
        <input
          type="password"
          id="tokenInput"
          placeholder="Enter your Discord token"
          autocomplete="off"
          spellcheck="false"
        />
        <button id="loadButton">Load</button>
        <button id="usePreviousTokenBtn" title="Use previously saved token">Use Previous Token</button>
      </div>
      <div id="serverSearchContainer">
        <input
          type="text"
          id="serverSearchInput"
          placeholder="Search servers..."
          autocomplete="off"
          spellcheck="false"
        />
      </div>
      <div id="serverList"></div>
    </div>
    <div id="mainContent">
      <div id="searchContainer">
        <input
          type="text"
          id="searchInput"
          placeholder="Search emojis..."
          autocomplete="off"
          spellcheck="false"
        />
      </div>
      <div id="emojiGrid"></div>
    </div>
  </div>
  <div id="tooltip">Copied!</div>

  <script>
    (() => {
      const tokenInput = document.getElementById('tokenInput');
      const loadButton = document.getElementById('loadButton');
      const usePreviousTokenBtn = document.getElementById('usePreviousTokenBtn');
      const serverList = document.getElementById('serverList');
      const serverSearchContainer = document.getElementById('serverSearchContainer');
      const serverSearchInput = document.getElementById('serverSearchInput');
      const mainContent = document.getElementById('mainContent');
      const searchContainer = document.getElementById('searchContainer');
      const searchInput = document.getElementById('searchInput');
      const emojiGrid = document.getElementById('emojiGrid');
      const tooltip = document.getElementById('tooltip');

      let currentToken = '';
      let guilds = [];
      let emojis = [];
      let filteredGuilds = [];
      let filteredEmojis = [];
      let selectedGuildId = null;

      // Show or hide Use Previous Token button based on localStorage
      function updateUsePreviousTokenButton() {
        const savedToken = localStorage.getItem('discordToken');
        if (savedToken) {
          usePreviousTokenBtn.style.display = 'block';
        } else {
          usePreviousTokenBtn.style.display = 'none';
        }
      }

      updateUsePreviousTokenButton();

      // Show tooltip at mouse position
      function showTooltip(x, y) {
        tooltip.style.left = x + 'px';
        tooltip.style.top = y + 'px';
        tooltip.style.opacity = '1';
        setTimeout(() => {
          tooltip.style.opacity = '0';
        }, 1000);
      }

      // Copy text to clipboard
      function copyToClipboard(text, x, y) {
        navigator.clipboard.writeText(text).then(() => {
          showTooltip(x, y);
        }).catch(() => {
          alert('Failed to copy to clipboard');
        });
      }

      // Render server list
      function renderServers(list) {
        serverList.innerHTML = '';
        if (list.length === 0) {
          const noServerDiv = document.createElement('div');
          noServerDiv.textContent = 'No servers found.';
          noServerDiv.style.padding = '20px';
          noServerDiv.style.color = 'var(--text-muted)';
          serverList.appendChild(noServerDiv);
          return;
        }
        list.forEach(guild => {
          const div = document.createElement('div');
          div.className = 'server-item';
          if (guild.id === selectedGuildId) div.classList.add('active');

          const img = document.createElement('img');
          img.className = 'server-icon';
          img.src = guild.iconURL || 'https://cdn-icons-png.flaticon.com/512/187/187210.png';
          img.alt = guild.name;
          div.appendChild(img);

          const span = document.createElement('span');
          span.textContent = guild.name;
          div.appendChild(span);

          div.addEventListener('click', () => {
            selectedGuildId = guild.id;
            renderServers(filteredGuilds);
            loadEmojis(guild.id);
          });

          serverList.appendChild(div);
        });
      }

      // Render emojis grid
      function renderEmojis(list) {
        emojiGrid.innerHTML = '';
        if (list.length === 0) {
          const noEmojiDiv = document.createElement('div');
          noEmojiDiv.textContent = 'No emojis found.';
          noEmojiDiv.style.padding = '20px';
          noEmojiDiv.style.color = 'var(--text-muted)';
          emojiGrid.appendChild(noEmojiDiv);
          return;
        }
        list.forEach(emoji => {
          const card = document.createElement('div');
          card.className = 'emoji-card';
          card.title = emoji.name;

          const img = document.createElement('img');
          img.className = 'emoji-image';
          img.src = emoji.url;
          img.alt = emoji.name;

          const nameSpan = document.createElement('span');
          nameSpan.className = 'emoji-name';
          nameSpan.textContent = emoji.name;

          card.appendChild(img);
          card.appendChild(nameSpan);

          card.addEventListener('click', e => {
            copyToClipboard(emoji.url, e.pageX, e.pageY);
          });

          emojiGrid.appendChild(card);
        });
      }

      // Filter servers by search input
      function filterServers() {
        const searchTerm = serverSearchInput.value.toLowerCase();
        filteredGuilds = guilds.filter(g => g.name.toLowerCase().includes(searchTerm));
        renderServers(filteredGuilds);
      }

      // Filter emojis by search input
      function filterEmojis() {
        const searchTerm = searchInput.value.toLowerCase();
        filteredEmojis = emojis.filter(e => e.name.toLowerCase().includes(searchTerm));
        renderEmojis(filteredEmojis);
      }

      // Load emojis for selected server
      function loadEmojis(guildId) {
        const guild = guilds.find(g => g.id === guildId);
        if (!guild) return;
        emojis = guild.emojis.map(e => ({
          id: e.id,
          name: e.name,
          url: `https://cdn.discordapp.com/emojis/${e.id}.${e.animated ? 'gif' : 'png'}?v=1`
        }));

        filteredEmojis = emojis;
        searchContainer.style.display = 'block';
        searchInput.value = '';
        filterEmojis();
      }

      // Fetch user guilds from Discord API
      async function fetchGuilds(token) {
        try {
          const res = await fetch('https://discord.com/api/v9/users/@me/guilds', {
            headers: {
              Authorization: token
            }
          });
          if (!res.ok) throw new Error('Invalid token or failed to fetch guilds');
          const data = await res.json();

          // Only keep guilds the user has permission to view emojis
          guilds = data.map(g => ({
            id: g.id,
            name: g.name,
            iconURL: g.icon
              ? `https://cdn.discordapp.com/icons/${g.id}/${g.icon}.png`
              : null,
            emojis: [] // will fill later
          }));

          // Fetch emojis for each guild (parallel)
          const emojisPromises = guilds.map(async guild => {
            try {
              const emojiRes = await fetch(`https://discord.com/api/v9/guilds/${guild.id}/emojis`, {
                headers: { Authorization: token }
              });
              if (!emojiRes.ok) return [];
              return await emojiRes.json();
            } catch {
              return [];
            }
          });

          const allEmojis = await Promise.all(emojisPromises);

          allEmojis.forEach((emojiList, idx) => {
            guilds[idx].emojis = emojiList;
          });

          filteredGuilds = guilds;
          renderServers(filteredGuilds);

          serverSearchContainer.style.display = 'block';
          mainContent.style.display = 'flex';

          // Select first guild by default if available
          if (guilds.length > 0) {
            selectedGuildId = guilds[0].id;
            renderServers(filteredGuilds);
            loadEmojis(selectedGuildId);
          }

          searchInput.value = '';
          searchInput.focus();

          return true;
        } catch (err) {
          alert(err.message);
          return false;
        }
      }

      // On load button click
      loadButton.addEventListener('click', async () => {
        const token = tokenInput.value.trim();
        if (!token) {
          alert('Please enter a token.');
          return;
        }
        loadButton.disabled = true;
        loadButton.textContent = 'Loading...';

        const success = await fetchGuilds(token);
        if (success) {
          currentToken = token;
          // Save token to localStorage
          localStorage.setItem('discordToken', token);
          updateUsePreviousTokenButton();
        }

        loadButton.disabled = false;
        loadButton.textContent = 'Load';
      });

      // Use Previous Token button click
      usePreviousTokenBtn.addEventListener('click', () => {
        const savedToken = localStorage.getItem('discordToken');
        if (savedToken) {
          tokenInput.value = savedToken;
          tokenInput.focus();
        }
      });

      // Search server input event
      serverSearchInput.addEventListener('input', filterServers);

      // Search emoji input event
      searchInput.addEventListener('input', filterEmojis);

      // Disable enter form submission on tokenInput
      tokenInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          loadButton.click();
        }
      });
    })();
  </script>
</body>
</html>
